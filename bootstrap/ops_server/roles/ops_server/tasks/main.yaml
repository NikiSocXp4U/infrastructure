- name: Ensure /etc/yum.repos.d exists
  ansible.builtin.file:
    path: /etc/yum.repos.d
    state: directory
    mode: "644"

- name: Add HashiCorp repo
  ansible.builtin.yum_repository:
    name: hashicorp
    description: Hashicorp Fedora Repo
    baseurl: https://rpm.releases.hashicorp.com/fedora/hashicorp.repo

- name: Install required packages
  become: true
  ansible.builtin.dnf:
    state: latest
    name:
      - git
      - snapd
      - gettext
      - terraform
      - openssh-server
      - cloud-init
      - ansible

- name: Ensure SSH server is running
  ansible.builtin.systemd:
    name: sshd
    state: started
    enabled: yes

- name: Install kubectl from Snap
  community.general.snap:
    state: present
    name:
      - kubectl

- name: Create operator user
  ansible.builtin.user:
    name: operator
    generate_ssh_key: yes

- name: Clone this repository
  ansible.builtin.git:
    repo: https://github.com/astralbijection/infrastructure.git
    dest: /infra
    version: main
    update: yes
    clone: yes
