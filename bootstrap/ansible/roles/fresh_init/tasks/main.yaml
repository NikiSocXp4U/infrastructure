- name: Change hostname
  ansible.builtin.hostname:
    name: "{{short_hostname}}"

- name: Alter /etc/hosts with new hostname
  ansible.builtin.template:
    src: hosts.j2
    dest: /etc/hosts
    mode: "644"

- name: Create Ansible user
  ansible.builtin.user:
    name: ansible
    comment: Ansible
    state: present
    append: yes
    create_home: yes
    groups: wheel

- name: Add authorized key for Ansible
  ansible.posix.authorized_key:
    user: ansible
    state: present
    key: "{{ssh_public_key}}"

- name: Allow ansible user to use sudo without a password
  ansible.builtin.copy:
    src: ansible-sudo
    dest: /etc/sudoers.d/ansible
    mode: "600"

- name: Create new connection definition
  ansible.builtin.template:
    src: static.nmconnection.j2
    dest: /etc/NetworkManager/system-connections/{{ interface }}.nmconnection
    mode: "600"

- name: Reboot without status check
  shell: reboot
  async: 1
  poll: 0
