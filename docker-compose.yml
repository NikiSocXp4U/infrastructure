version: "3.7"
services:
  caddy:
    image: caddy:alpine
    container_name: caddy
    restart: always
    env_file: .env

    volumes:
      - ./caddy/:/etc/caddy/
    ports:
      - "80:80"
      - "443:443"

  minecraft-server:
    image: itzg/minecraft-server
    hostname: mc
    container_name: mc

    tty: true
    stdin_open: true
    restart: unless-stopped

    volumes:
      - ./data:/data
    ports:
      - 25575:25575
      - 25565:25565

    environment:
      EULA: "TRUE"
      TYPE: FABRIC
      MOTD: Some Server Dot Jay Peg

    env_file: .env

  minecraft-exporter:
    image: joshi425/minecraft_exporter
    hostname: mc-exporter
    container_name: mc-exporter

    command: >
      sh -c "sleep 10; python minecraft_exporter.py"

    environment:
      RCON_HOST: mc
      RCON_PORT: 25575
      DYNMAP_ENABLED: "True"
    volumes:
      - ./data/world:/world
    env_file: .env

    depends_on:
      - minecraft-server
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.1.0
    hostname: node-exporter
    container_name: node-exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - "--path.procfs=/host/proc"
      - "--path.rootfs=/rootfs"
      - "--path.sysfs=/host/sys"
      - "--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)"
    restart: unless-stopped
    expose:
      - 9100
